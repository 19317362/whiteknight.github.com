---
layout: bloggerpost
title: Parrot on Win64
---

For the past few weeks I've been idly trying to get Parrot building and running on 64-bit Windows. With the release quickly approaching and Christoph laying down a feature freeze, I've been doubling my efforts to get something working on this system. Astute observers will notice that there have been smolder reports coming from "MSWin32" on "amd64" processors, but this is an illusion. Parrot does indeed build and run on a 64-bit Windows platform, if you compile it into a 32-bit binary with a 32-bit compiler. However, this isn't exactly the same thing as having a 64-bit bird. So all the previous smolder reports we have from "Win64" or "Windows - amd64" are reports of 32-bit birds on those platforms. After a lot of effort I've managed to finally upload an <a href="http://smolder.plusthree.com/app/public_projects/report_details/25220">actual smolder report of a 64-bit bird on Win64</a>, and it's not pretty.<br /><br /><span style="font-size:180%;">64-Bit Compiler</span><br /><br />The first big problem with Win64 is that there aren't too many compilers there. MinGW, a port of GCC to Windows (and the compiler that ships with Strawberry Perl), doesn't have a 64-bit version on Windows available yet. At least, not a stable one. Consequently Strawberry Perl doesn't have a 64-bit distribution. I don't know if ActiveState offers a 64-bit Perl, but that still wouldn't have a compiler associated with it.<br /><br />Microsoft offers it's 64-bit compiler for free on that platform, but it's hard to find any free alternatives to that. However, Microsoft doesn't offer a 64-bit version of visual studio yet (that I am aware of), so we're doing this all on the command line with the Microsoft C compiler <code>cl</code>.<br /><br /><span style="font-size:180%;">Compiling with 64-bit cl.exe</span><br /><br />I've found this incantation seems to get us through the compilation process and allows us to run the test suite without too much hackery:<br /><pre><br />perl Configure.pl --ccflags="-GS- -MD" --intval="long long" --opcode="long long"<br /></pre><br />At least, this incantation should work after <a href="https://trac.parrot.org/parrot/changeset/40176/">r40176</a>.<br /><br /><span style="font-size:180%;">Win64 Problems</span><br /><br />I mentioned earlier that one of the problems on Win64 is finding a compiler. There are some that cost $$$, but I'm poor and refuse to buy a compiler for this work. If somebody has access to a proprietary one that might perform better I would love to hear about it. However, the compiler isn't the only problem.<br /><br />For backwards compatibility, the Microsoft C compiler on Win64 treats "<code>int</code>" and "<code>long</code>" values as being both 32-bit quantities. If you want access to a 64-bit integer type, you need to use "<code>long long</code>". While it shouldn't, Parrot currently expects the size of INTVAL to be the same as the size of a pointer. It's bad practice, but that's the way things are right now. So, that's why you see the bits <code>--intval="long long"</code> and <code>--opcode="long long"</code> in the Configure.pl command line up there: To make sure these things are both 64-bit quantities.<br /><br />[<span style="font-weight: bold;">Update 22 July 2009:</span> particle pointed me to <a href="http://www.unix.org/version2/whatsnew/lp64_wp.html">this article, which explains the 64-bit landscape better then I do</a>. For reference, Win64 with MSVC is "LLP64", while GCC on it's various supported platforms (including, I hope, MinGW when a 64-bit port of that is finally released) is LP64 instead.]<br /><br />Another problem is a major lack of important definitions of things that support 64-bit programming. For instance, MSVC doesn't seem to define the values <code>LLONG_MAX</code> and <code>LLONG_MIN</code>, even though the C89 standard specifies them. Instead, MSVC provides the idiosyncractic <code>_I64_MAX</code> and <code>_I64_MIN</code> macros. MSVC also doesn't provide a <code>strtoll</code> function, for converting an ASCII string into a <code>long long int</code>. It does have <code>strtol</code>, but since <code>long</code> is only 32 bit, this function only returns a 32-bit quantity. This is a huge problem inside IMCC, which uses <code>strtol</code>, because suddenly a 64-bit Parrot on a 64-bit platform can't handle 64-bit integer constants in PIR code. Bummer.<br /><br /><span style="font-size:180%;">Parrot Has a Problem</span><br /><br />Microsoft isn't the only guilty party in this situation, one major problem in this process is actualy Parrot's fault: Parrot assumes throughout the codebase that INTVALs and pointers are the same size, and it casts data from one to the other without considering possible truncation. It's not hugely prevalent, but it does happen in several systems and in ways that are not going to be easy to resolve. One place where it happens very frequently is in the <code>get_pointer</code> and <code>set_pointer</code> VTABLEs, which we can resolve by preventing these two from ever being used in a way that pointer values are accessible to PIR code.<br /><br />A lot of code cleanup is going to have to happen in Parrot, some of it painful, in order to get Parrot properly building on more of these "exotic" systems like Win64. Luckily this is a problem that can be broken down into small chunks, and might be a perfect job for <a href="http://wknight8111.blogspot.com/search/label/Parrot4Newbies">new Parrot hackers</a> to play with. However, this problem will definitely not be resolved by the release tomorrow, and may not be resolved for several releases to come.<br /><br /><span style="font-size:180%;">Conclusion</span><br /><br />So that's the state of Parrot on Win64. The release tomorrow is going to be shipping with the very first Win64 entry in the <code>PLATFORMS</code> file, although a quick glance at it will show that it's not nearly the success story that other platforms are. 64-bit Ubuntu is an example of a platform that has great support, although that's because of the large number of Parrot developers that use it. Like other amd64 platforms, Win64 doesn't have JIT either, so that's not a mark against it. I would like to see support for Parrot on Win64 improved, but I'm not hopeful that it's going to happen any time soon.