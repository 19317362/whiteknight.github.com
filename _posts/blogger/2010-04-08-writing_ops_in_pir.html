---
layout: bloggerpost
title: Writing Ops in PIR
publish: true
categories: [PIR, Parrot]
---

I put together an interesting little code snippet a few days ago that, when finished, would allow writing ops in PIR. I am probably not going to complete work on this idea myself (at least, not any time soon), so I want to put the partially-written code up here for other people to look at and maybe run with.<br /><br /><pre>BEGIN_OPS_PREAMBLE<br /><br />opcode_t *<br />Parrot_pir_op_lib_wrapper_func(opcode_t *cur_opcode, PARROT_INTERP)<br />&#123;<br />    // TODO: Set dest to the address of the next instruction, after all arguments.<br />    //       need to parse the number of args from the op signature<br />    opcode_t * dest = cur_opcode + 3;<br />    INTVAL opnum = (INTVAL)(*cur_opcode);<br />    char * const opname = interp->op_info_table[opnum]->name;<br />    STRING * name = string_make(interp, opname, 8, "ascii",<br />        PObj_constant_FLAG|PObj_external_FLAG);<br />    PMC * const root_ns = interp->root_namespace;<br />    PMC * const ns = Parrot_get_namespace_keyed(interp, root_ns, CONST_STRING(interp, "pir_op_lib"));<br />    PMC * sub = VTABLE_get_pmc_keyed_str(interp, ns, name);<br /><br />    // TODO: Need to convert the op signature into a PCC signature here<br />    PMC * call_sig = Parrot_pcc_build_sig_object_from_op(interp, PMCNULL, signature,<br />        cur_opcode);<br />    Parrot_pcc_set_signature(interp, CURRENT_CONTEXT(interp), call_sig);<br />    interp->current_cont   = NEED_CONTINUATION;<br /><br />    dest = VTABLE_invoke(interp, sub, dest);<br />    goto ADDRESS(dest);<br />&#125;<br /><br />END_OPS_PREAMBLE<br /><br />op register_op_sub(IN STR, IN STR, IN PMC) &#123;<br />    PMC * const root_ns = interp->root_namespace;<br />    PMC * const sub = $3;<br />    PMC * const key = Parrot_pmc_new(interp, enum_class_ResizableStringArray);<br />    STRING * const opname = $1;<br />    STRING * const sig = $2;<br />    PMC * const ns = Parrot_get_namespace_keyed(interp, root_ns, CONST_STRING(interp, "pir_op_lib"));<br />    INTVAL argcount = 3; // TODO: Count number of args in signature<br />    STRING * const separator = CONST_STRING(interp, "_");<br />    STRING * longname = Parrot_str_append(interp, opname, separator);<br />    longname = Parrot_str_append(interp, longname, sig);<br /><br />    VTABLE_set_string_keyed_int(interp, key, 0, );<br /><br />    VTABLE_set_pmc_keyed_str(interp, ns, $2, sub);<br />    op_info_t * new_op = (op_info_t *)malloc(sizeof(op_info_t));<br />    new_op->name = Parrot_str_to_cstring(interp, opname);<br />    new_op->full_name = Parrot_str_to_cstring(interp, longname);<br />    new_op->jump = 0;<br />    new_op->opcount = argcount + 1;<br /><br />    // TODO: Initialize ->type based on what's in signature<br />    new_op->type = (arg_type_t *)malloc(sizeof(arg_type_t) * PARROT_MAX_ARGS);<br /><br />    // TODO: Initialize based on the signature<br />    new_op->dirs = (arg_dir_t *)malloc(sizeof(arg_dir_t) * PARROT_MAX_ARGS);<br /><br />    // TODO: what is this?<br />    new_op->labels = (char *)malloc(sizeof(char) * PARROT_MAX_ARGS);<br /><br />    // TODO: Insert the new op into the optable.<br />&#125;</pre><br />This code, intended to become a dynop library one day, introduces a single new op: register_op_sub. register_op_sub takes three arguments: the string name of the new op, the string signature of the new op, and the Sub PMC for the new op. An entry is prepared for the interpreter's op_lib table (I haven't found a good way to insert that record yet), and the sub is stored in the "pir_op_lib" namespace. The body of the new op is the function Parrot_pir_op_lib_wrapper. This function body looks up the name of the current op in the op_lib table, then looks up the Sub PMC in the namespace, and will attempt to invoke that sub.<br /><br />I haven't worked out all the mechanics of everything, obviously. But once a few more questions get answered and a modest amount of code gets written, this could turn into a very useful and very cool extension library for Parrot.