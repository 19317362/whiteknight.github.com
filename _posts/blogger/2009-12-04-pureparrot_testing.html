---
layout: bloggerpost
title: Pure-Parrot Testing
publish: true
categories: [Testing, Parrot, MockObject]
---

I had mentioned the nqpTAP project that dukeleto started a while back to provide a pure-Parrot testing harness. A few days ago he completely rewrote the project and <a href="http://github.com/leto/tapir">re-released it as Tapir</a> (a clever <a href="http://en.wikipedia.org/wiki/Portmanteu">portmanteu</a> of "TAP" and "PIR"). The test harness is written in PIR instead of NQP now, is more robust, and is self-testable. Dukeleto also apparently has plans to make it more configurable and maybe even pluggable, things which I am very excited about.<br /><br />I would like to migrate <a href="http://github.com/Whiteknight/parrot-linear-algebra">Parrot-Linear-Algebra</a> and <a href="http://github.com/Whiteknight/matrixy">Matrixy</a> to use the new harness, and I'm sure other projects would like that as well. These two might make cool test cases. I'll post details when I have a good procedure for doing that.<br /><br />This got me thinking more about a project I've been incubating in the back of my head for a while: I've been wanting to have a <a href="http://en.wikipedia.org/wiki/Mock_Object">mock object</a> testing framework for Parrot, and I think it would be reasonably easy to make one. So I'm going to draft out some of my ideas here.<br /><br />First thing we want is the actual mock object type. Call it "MockObject" for short. This object type, once initialized with a number of options and restrictions, should act exactly like a normal object. It should provides methods, respond to VTABLE calls, and do all sorts of things that a normal object of the given type would do. The difference, of course, is that MockObject is just pretending.<br /><br />Pretend I have a large system that needs to be tested. I pass request objects to it, and the system in turn accesses properties and methods in that request. I want to test and verify that my system is calling the correct methods with the correct arguments, and is accessing values in the proper order. To do this, I need to create a MockObject, and pass that object to my system to verify that things are happening correctly.<br /><br />So a MockObject needs to respond to certain behaviors:<br /><ol><li>Must be able to respond to method calls (including handling calls to methods which should not exist), being able to expect and verify parameter lists.</li><li>Must be able to respond to vtable calls, being able to expect parameter values.<br /></li><li>Must be able to log method calls, vtable calls, and property accesses to verify order</li></ol>A MockObject needs to act exactly like the kind of object it is impersonating, so it really can't have a public interface of it's own. Any interface that MockObject implements for itself is going to be unusable for testing, and even if we keep that interface small there is always going to be that overlap where we can't test. To avoid this, we need to be able to configure MockObject without having any visible interface. Sounds rough, eh?<br /><br />So here's what I'm thinking. First, we have a MockManager class that contains the configuration methods for MockObject. To configure a MockObject, we don't call methods directly on it, we instead pass it to methods on the MockManager class. This saves us from overlapping interfaces in PIR-land. Second, we need to provide two interfaces: the "normal" PIR interface that perfectly imitates the target type, and the internal interface that MockManager uses for configuration. At the C level, we can have two VTABLE structures, which we swap out manually when doing configuration.<br /><br />So without any further adeu, I would like to show some PIR code that demonstrates how I think MockObject could be used in PIR code as part of a normal test:<br /><pre><br />.local pmc mock, manager<br />.local int result<br />manager = new ['MockManager']<br />mock = manager.'new_mock'('ResizablePMCArray')<br />manager.'expect'(mock, 'sort')<br />mock.'sort'()<br />result = manager.'success'(mock)<br />ok(result, "the sort method was called!")<br /></pre><br />So we create a MockObject that is supposed to act like a ResizablePMCArray. We setup the expectation that the sort method is going to be called with no arguments. After we've called that method, we check to see that all our expectations were met. This test above should pass.<br /><br />There are obviously a lot of issues raised by this potential implementation and a lot of questions that still need to be addressed before we can use any of this. However, I do think this would be a great project and very usable for a number of projects. I would definitely love to hear what other people think about it as well.
                <div class='old-blogger-comments'>
                    <h2 class='old-comment-header'>Comments</h3>
                
<div class='blogger-comment-div'>
    <a name='6270678549922411005'></a>
    <p class='blogger-comment-body'>
        I like your idea of the MockObject.  I wonder if you'll find that you need the MockObject to contain an actual instance of the intended object in order to produce side effects or return the correct results for the calling code to continue.  It might be better for MockObject's constructor to take a real object and fake the VTABLE (etc), pass everything through to the real object untouched, but record the operations.  Tests could still verify that methods were called (and in the correct order).  The MockManager interface could then be focused on letting tests modify the behavior (e.g. produce exceptions on certain methods to test error-handling code) instead of faking an interface that can be automatically copied from an existing object.
    </p>
    <div class='blogger-comment-author-div'>
        <span class='blogger-author-sig'><a class='blogger-author-uri' href='http://www.blogger.com/profile/04684398903476471433'>Andy</a>
</span>
        <span class='blogger-comment-datestamp'>
            <a class='blogger-comment-link' href='{{ post.url }}#6270678549922411005'>
                12/7/2009 12:53:52 PM
            </a>
        </span>
    </div>
</div>
</div>
