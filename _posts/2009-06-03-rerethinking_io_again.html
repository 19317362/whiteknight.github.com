---
layout: bloggerpost
title: Re-Rethinking IO, Again
publish: true
categories: [Parrot, IO]
---

Had a good <a href="http://irclog.perlgeek.de/parrot/2009-06-03#i_1205069">talk with Allison last night</a> about <a href="/2009/05/29/io_work_proceeds_with_questions.html.html">my ongoing IO work</a>, and got a lot of great ideas. It's good to have people in the project that are so great for bouncing ideas off of. We decided a few things:<br /><ol><li>The way I was using "roles" and the <code>does</code> VTABLE was a pretty egregious abuse, and very misleading. It did identify capabilities, but that wasn't the right way to do it.</li><li>If we're going to support polymorphism, we're going to do it right. Unfortunately, the right way to do it is through methods, which is what I was trying to avoid in the first place.</li><li>So, for the common case of built-in PMCs and direct subclasses, we can use direct <code>ATTR</code> accesses to do IO quickly. For other types, we default to calling the appropriate method. This does the common case quick, and the fancy-schmance case less quickly.</li></ol>So, with all this in mind I am going to revert several of the changes I've made to some files, and start redoing things in the "right way". It's never too late to get things right though, and I definitely don't mind the extra work. Here's what this all means:<br /><br /><ol><li>The common case, of builtin PMCs (<a href="https://trac.parrot.org/parrot/browser/trunk/src/pmc/filehandle.pmc">FileHandle</a>, <a href="https://trac.parrot.org/parrot/browser/branches/io_rewiring/src/pmc/pipe.pmc">Pipe</a>, <a href="https://trac.parrot.org/parrot/browser/branches/io_rewiring/src/pmc/pipehandle.pmc">PipeHandle</a>, <a href="https://trac.parrot.org/parrot/browser/trunk/src/pmc/socket.pmc">Socket</a>, <a href="https://trac.parrot.org/parrot/browser/trunk/src/pmc/stringhandle.pmc">StringHandle</a>) will be handled quickly because Parrot's core has an intimate knowledge of the internals of these PMC types. Also, subclassing these types should Just Work, assuming we can abstract things properly so all ATTRs of these types are subclassable (INTVAL, FLOATVAL, STRING * or PMC *). Notice that the C-based PMCs converted with the Pmc2c.pl utility will have difficulty because the base type identifier will not match that of the builtin PMC types.<br /></li><li>The uncommon case, of using any arbitrary PMC type for IO, will be supported but less quickly. We will call named methods to implement various behaviors ("read" method to read, "open" method to open, etc).<br /></li><li>The user-visible interface won't be changing through any of these refactors, so we won't need a deprecation cycle. It's an in-place optimization.</li></ol>So that's the changes in a nutshell, and I'm hoping that the end result is good and fast for most cases. I'm hoping to power out some changes this week before some of <a href="/2009/06/01/wittie_wiki_project.html.html">my other projects</a> take over most of my free time. I am <a href="/2009/05/22/my_personal_roadmap_for_parrot_20.html.html">still planning</a> to have these IO refactors land before <a href="http://irclog.perlgeek.de/parrotsketch/2009-05-26#i_1177519">the next release</a>, so that I can get working hard on <a href="/2009/05/05/path_to_aio_on_parrot.html.html">AIO</a> in July.