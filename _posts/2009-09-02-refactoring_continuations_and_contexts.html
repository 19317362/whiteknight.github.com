---
layout: bloggerpost
title: Refactoring Continuations and Contexts
---

<span style="font-style: italic;">I've written, on average, about 1.5 posts per day in the last two weeks, but haven't managed to post any of them. Sorry about the delay!</span><br /><br />When <a href="http://wknight8111.blogspot.com/2009/08/parrot-150-teh-parrotz-released.html">1.5.0 was released</a>, the Sub and Continuation PMCs were just garbage collectible wrappers around the C structs <code>Parrot_sub</code> and <code>Parrot_cont</code> respectively. My initial attempt at a Context PMC would have followed this same mold, applying a thin garbage-collectible wrapper around the <code>Parrot_context</code> structure. This was certainly not ideal for a number of reasons (multiple allocations, extra layers of pointer dereferencing, lots of extra pointer-checking code to make sure everything is where we think it is, etc), but it would have helped to plug the memory leaks introduced by the reference-counting context system as-is.<br /><br />Shortly after 1.5.0 was released, however, <a href="http://wknight8111.blogspot.com/2009/08/branches-come-crashing-in.html">bacek's branch to clean up the Sub PMC landed</a>, and got rid of the <code>Parrot_sub</code> structure entirely (converting all it's fields into attributes for the PMC). He quickly started work on the Context PMC next, throwing out what little work I had done and moved towards a comprehensive Context refactor. He wasn't just turning the Context PMC into a thin wrapper, he was converting Parrot to have a proper Context PMC wholesale. It was what <a href="http://wknight8111.blogspot.com/2009/08/contexts-path-forward-and-problems.html">I was planning to do</a>, though I would have spread it out over several steps and several branches.<br /><br />His work created a <a href="http://lists.parrot.org/pipermail/parrot-dev/2009-August/002728.html">little bit of a stir</a> because it ran afoul of the deprecation policy: Some users were poking directly into the guts of the <code>Parrot_context</code> structure, and his work would have broken that. Nobody said "no", but there was definitely some stalling and arguing about the finer points of the deprecation policy. Plus, he had a weird failure in JIT (Which I will discuss in depth with my next post), so he couldn't merge immediately anyway.<br /><br />A few days ago I saw a <a href="https://trac.parrot.org/parrot/ticket/926">very cool diff from newcomer jrtayloriv</a> to perform the conversion for the Continuation PMC and the <code>Parrot_cont</code> structure. The diff wasn't completely ready to apply to trunk yet, but it was an amazing start and came out of the blue absolutely unexpected. What his patch did was merge the fields of the <code>Parrot_cont</code> structure into the attributes of the Continuation PMC, and replace references to "<code>Parrot_cont</code>" with "<code>Parrot_Continuation_attributes</code>". It's not a huge change to be sure, and it doesn't do anything to address the poor encapsulation of the Continuation PMC, but it's a great first step in a comprehensive cleanup and refactor of that system.  I created the <code>kill_parrot_cont</code> branch to test that patch, and after a few more patches from jrtayloriv and help from some other commiters it matured nicely.<br /><br />Tonight, both branches became 100% ready to merge. chromatic fixed the JIT failure in bacek's branch, and also "clarified" the deprecation policy to smooth the way for these changes. It helped that many of Parrot's users, especially Rakudo, were strongly in favor of a merge sooner rather then later. jrtayloriv got all the rest of <a href="http://smolder.plusthree.com/app/public_projects/report_details/26801">his tests passing</a> and cleaned up things that needed it, and decided to get the branch merged before making too many more changes. I sent an <a href="http://lists.parrot.org/pipermail/parrot-dev/2009-September/002769.html">email to the list</a> about these two, and am waiting for some feedback. Hopefully we can get both branches reviewed and approved by the end of this week, which gives us about a week and a half to clean up the wreckage and get trunk in shape for the 1.6.0.<br /><br />1.6.0 is certainly going to be an eventful release. A lot of good branches have merged already and more are on the way. On top of that, we're seeing some great interest from newcomers that is translating to real code being applied. Hopefully we'll have a few new committers in the next coming weeks to help us with all these ambitious changes that we are making.