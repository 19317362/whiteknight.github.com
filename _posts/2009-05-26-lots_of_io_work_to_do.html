---
layout: bloggerpost
title: Lots of IO work to do
---

It's no secret that I've been planning pretty aggressively to <a href="http://wknight8111.blogspot.com/2009/05/asynchronous-io-in-parrot.html">implement an asynchronous IO subsystem</a> for Parrot. However, this is really just one part of a larger group of projects that the IO system needs.<br /><br />Today in the <a href="http://irclog.perlgeek.de/parrotsketch/2009-05-26">weekly Parrotsketch meeting</a>, a lot of IO-related issues were raised. Several people mentioned performance issues, which seems to be a hot button issue in Parrot-world and for good reason. The way the IO system API is currently implemented is as a thin wrapper layer around PCCINVOKE method calls for the FileHandle and related PMCs. This implementation works decently, and was necessary for a time to support performing IO operations on a <a href="https://trac.parrot.org/parrot/ticket/707">wide array</a> of hypothetical IO PMCs, but there is a <a href="http://lists.parrot.org/pipermail/parrot-dev/2009-February/001369.html">huge overhead</a> involved in calling all those PMC methods. In fact, it was this very issue that prompted the <a href="http://wknight8111.blogspot.com/2009/05/calling-conventions-work.html">current round of PCC refactors</a>. Instead of having IO PMCs related simply by sharing a common set of methods, it's probably much better for these PMCs to be related together by inheritance and to use a common set of C functions to access their common VTABLEs and attributes directly.<br /><br />So <a href="http://irclog.perlgeek.de/parrot/2009-05-27#i_1178470">Infinoid and I</a> have been putting together <a href="https://trac.parrot.org/parrot/wiki/IOTasklist">a plan</a> tonight and I'm pretty excited about it. Here are some of the main points:<br /><ol><li>We're refactoring the PMC hiearchy. IO types will all derive from a common Handle type that will have a few common attributes, vtables, and methods.</li><li>We're going to refactor FileHandle to subclass from Handle</li><li>We're going to fix Socket so that it subclasses Handle, and not FileHandle</li><li>We're going to use roles and the VTABLE_does to determine the capabilities of each type of IO PMC. Roles like "read", "write", "file", "socket" and "pipe" will determine capabilities. Then we can also have subroles, like "connection" and "connectionless" for different types of sockets, etc.</li><li>Try to fix attributes, where possible, to be inheritable so we can subclass all these things from PIR reliably</li><li>Change the IO API to use C functions instead of PCCINVOKE methods to perform operations. We sacrifice a little bit of encapsulation for big performance gains, but I think it's a worthwhile change.</li></ol>After this, Infinoid is really looking to get an IO multiplexing "Select" PMC put together, and I'm looking at <a href="http://wknight8111.blogspot.com/2009/05/path-to-aio-on-parrot.html">getting AIO in place</a>. I was planning to do something like Select as part of the AIO work, but I'm not sure that my idea is the best for general purpose use. I'm still considering using an "IOListener" that will check IO events as part of the scheduler, but that could be the asynchronous equivalent of a manually-polled Select PMC. Maybe we need both, maybe we only need one. We'll see how it goes.<br /><br />My goal is to get this cleanup work done within 1-2 weeks, and with a great coder like Infinoid in my team I think it's completely possible. After that, I have the ambitious goal of getting AIO implemented, or at least a working subset of it, <a href="http://wknight8111.blogspot.com/2009/05/my-personal-roadmap-for-parrot-20.html">by the 1.3 release</a> (that I am the release manager for). Certainly by 1.5 Parrot is going to have a world-class IO system available, which is perfect timing because that's when a few of my other tasklist items <a href="http://wknight8111.blogspot.com/2009/05/blocked-tasks-and-starting-aio.html">become unblocked</a>.